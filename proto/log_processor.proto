syntax = "proto3";

package log_processor;

// 로그 프로세서 서비스
service LogProcessor {
  // 로그 파일을 파싱하고 Parquet으로 변환하여 업로드 (스트리밍 응답으로 진행상황 전달)
  rpc ProcessLogs(ProcessLogsRequest) returns (stream ProcessLogsProgress);
  
  // Parquet 파일을 CSV로 변환하여 업로드 (스트리밍 응답으로 진행상황 전달)
  rpc ConvertToCsv(ConvertToCsvRequest) returns (stream ConvertToCsvProgress);
  
  // 작업 상태 조회
  rpc GetJobStatus(JobStatusRequest) returns (JobStatusResponse);
  
  // 버킷의 파일 목록 조회
  rpc ListFiles(ListFilesRequest) returns (ListFilesResponse);
}

// 로그 처리 요청
message ProcessLogsRequest {
  // 소스 버킷 이름
  string source_bucket = 1;
  
  // 소스 로그 파일 경로
  string source_path = 2;
  
  // 타겟 버킷 이름
  string target_bucket = 3;
  
  // Parquet이 저장될 경로
  string target_path = 4;
  
  // 로그 타입 (ufs, block, ufscustom)
  string log_type = 5;
  
  // 청크 크기 (옵션, 기본값: 100000)
  optional int32 chunk_size = 6;
  
  // 필터 옵션 (옵션)
  optional FilterOptions filter = 7;
}

// 로그 처리 진행 상황 (스트리밍)
message ProcessLogsProgress {
  // 작업 ID
  string job_id = 1;
  
  // 진행 단계
  ProgressStage stage = 2;
  
  // 진행 메시지
  string message = 3;
  
  // 진행률 (0-100)
  int32 progress_percent = 4;
  
  // 처리된 레코드 수
  int64 records_processed = 5;
  
  // 성공 여부 (완료시에만)
  optional bool success = 6;
  
  // 에러 메시지 (실패시에만)
  optional string error = 7;
  
  // 생성된 파일 경로들
  repeated string output_files = 8;
}

// 진행 단계
enum ProgressStage {
  STAGE_UNKNOWN = 0;
  STAGE_DOWNLOADING = 1;
  STAGE_PARSING = 2;
  STAGE_CONVERTING = 3;
  STAGE_UPLOADING = 4;
  STAGE_COMPLETED = 5;
  STAGE_FAILED = 6;
}

// 작업 상태 조회 요청
message JobStatusRequest {
  string job_id = 1;
}

// 작업 상태 응답
message JobStatusResponse {
  string job_id = 1;
  ProgressStage stage = 2;
  string message = 3;
  int32 progress_percent = 4;
  int64 records_processed = 5;
  bool is_completed = 6;
  optional bool success = 7;
  optional string error = 8;
}

// 파일 목록 조회 요청
message ListFilesRequest {
  string bucket = 1;
  string prefix = 2;
}

// 파일 목록 응답
message ListFilesResponse {
  repeated string files = 1;
}

// CSV 변환 요청
message ConvertToCsvRequest {
  // 소스 버킷 이름
  string source_bucket = 1;
  
  // 소스 Parquet 파일 경로
  string source_parquet_path = 2;
  
  // 타겟 버킷 이름
  string target_bucket = 3;
  
  // CSV가 저장될 경로
  string target_csv_path = 4;
  
  // CSV 파일 prefix (옵션, 기본값: trace_type)
  optional string csv_prefix = 5;
  
  // 필터 옵션 (옵션)
  optional FilterOptions filter = 6;
}

// CSV 변환 진행 상황 (스트리밍)
message ConvertToCsvProgress {
  // 작업 ID
  string job_id = 1;
  
  // 진행 단계
  CsvConversionStage stage = 2;
  
  // 진행 메시지
  string message = 3;
  
  // 진행률 (0-100)
  int32 progress_percent = 4;
  
  // 처리된 레코드 수
  int64 records_processed = 5;
  
  // 성공 여부 (완료시에만)
  optional bool success = 6;
  
  // 에러 메시지 (실패시에만)
  optional string error = 7;
  
  // 생성된 CSV 파일 경로들
  repeated string csv_files = 8;
}

// CSV 변환 진행 단계
enum CsvConversionStage {
  CSV_STAGE_UNKNOWN = 0;
  CSV_STAGE_DOWNLOADING = 1;
  CSV_STAGE_CONVERTING = 2;
  CSV_STAGE_UPLOADING = 3;
  CSV_STAGE_COMPLETED = 4;
  CSV_STAGE_FAILED = 5;
}

// 필터링 옵션
message FilterOptions {
  // 시작 시간 (ms)
  double start_time = 1;
  
  // 종료 시간 (ms)
  double end_time = 2;
  
  // 시작 섹터/LBA
  uint64 start_sector = 3;
  
  // 종료 섹터/LBA
  uint64 end_sector = 4;
  
  // 최소 Device to Complete 레이턴시 (ms)
  double min_dtoc = 5;
  
  // 최대 Device to Complete 레이턴시 (ms)
  double max_dtoc = 6;
  
  // 최소 Complete to Complete 레이턴시 (ms)
  double min_ctoc = 7;
  
  // 최대 Complete to Complete 레이턴시 (ms)
  double max_ctoc = 8;
  
  // 최소 Complete to Device 레이턴시 (ms)
  double min_ctod = 9;
  
  // 최대 Complete to Device 레이턴시 (ms)
  double max_ctod = 10;
  
  // 최소 Queue Depth
  uint32 min_qd = 11;
  
  // 최대 Queue Depth
  uint32 max_qd = 12;
  
  // 필터링할 CPU 번호 목록
  repeated uint32 cpu_list = 13;
}
