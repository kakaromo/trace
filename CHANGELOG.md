# 변경사항 로그 (2025년 7월 6일)

## 주요 변경사항

### 1. 자동 처리 모드 선택 기능 추가
- **파일**: `src/main.rs`
- **변경내용**:
  - `--highperf` 옵션 제거
  - `get_file_size()` 함수 추가: 파일 크기 확인
  - `determine_processing_mode()` 함수 추가: 파일 크기 기반 모드 결정
  - 1GB 이상 파일은 자동으로 고성능 모드, 1GB 미만은 스트리밍 모드
  - `--streaming` 옵션으로 수동 스트리밍 모드 강제 가능

### 2. Block Parquet 스키마 일관성 개선
- **파일**: `src/output/parquet.rs`
- **변경내용**:
  - `save_block_to_parquet()` 함수의 스키마를 `models/block.rs`와 완전히 일치
  - 누락된 필드 추가: `comm`, `qd`
  - 필드 매핑 정확성 향상: `sector` 필드 올바른 매핑
  - 모든 Block 구조체 필드가 Parquet 스키마에 포함

### 3. 성능 최적화
- **파일**: `src/output/parquet.rs`
- **변경내용**:
  - 병렬 처리를 통한 chunk 단위 데이터 처리
  - 사전 할당된 벡터 사용으로 메모리 효율성 향상
  - 순차적 파일 쓰기로 I/O 성능 최적화

## 영향 범위

### 사용자 인터페이스
- `--highperf` 옵션 제거로 CLI 인터페이스 단순화
- 파일 크기 기반 자동 모드 선택으로 사용 편의성 향상
- `--streaming` 옵션 추가로 수동 제어 가능

### 데이터 일관성
- Block 데이터 Parquet 저장 시 모델 정의와 완전히 일치
- 기존 Parquet 파일 호환성 문제 해결 (새로운 파일 생성 필요)

### 성능
- 대용량 파일 처리 시 자동으로 최적 모드 선택
- Parquet 저장 성능 향상

## 호환성 주의사항

### 기존 Parquet 파일
- 이전 버전에서 생성된 Block Parquet 파일은 스키마 불일치로 읽기 오류 발생 가능
- 새로운 버전으로 재생성 필요

### CLI 인터페이스
- `--highperf` 옵션 사용 시 오류 발생 (제거됨)
- 자동 모드 선택으로 대부분의 경우 옵션 지정 불필요

## 테스트 결과

### 자동 모드 선택 테스트
- 소형 파일 (< 1GB): 스트리밍 모드 자동 선택 ✓
- 대형 파일 (≥ 1GB): 고성능 모드 자동 선택 ✓
- `--streaming` 옵션: 강제 스트리밍 모드 ✓

### Block Parquet 스키마 테스트
- 모든 Block 구조체 필드 포함 확인 ✓
- 데이터 타입 정확성 확인 ✓
- 필드 순서 일관성 확인 ✓

## 향후 계획

### 단기 목표
- ✅ 기존 Parquet 파일 마이그레이션 도구 개발 (완료)
- ✅ 압축 알고리즘 개선 (완료)
  - 동적 압축 알고리즘 선택: 데이터 크기에 따라 SNAPPY/ZSTD 자동 선택
  - 소형 데이터 (< 1MB): SNAPPY (빠른 속도)
  - 중형 데이터 (1MB ~ 10MB): ZSTD 레벨 3 (균형)
  - 대형 데이터 (10MB ~ 100MB): ZSTD 레벨 6 (높은 압축률)
  - 초대형 데이터 (≥ 100MB): ZSTD 레벨 9 (최고 압축률)
  - 딕셔너리 압축 활성화로 압축률 향상
  - 청크 단위 통계로 성능과 압축률 균형 유지

### 장기 목표
- 실시간 로그 분석 기능 추가
- 웹 기반 대시보드 개발

## 마이그레이션 도구 개발 완료 (2025년 7월 6일)

### 새로운 기능
- **파일**: `src/migration/parquet_migrator.rs` 추가
- **변경내용**:
  - 기존 Parquet 파일 스키마 자동 감지
  - Block 및 UFS 파일 타입 지원
  - 스키마 호환성 검증 및 자동 변환
  - 배치 처리를 통한 메모리 효율적인 마이그레이션
  - 백업 파일 자동 생성 옵션
  - 재귀적 디렉토리 마이그레이션 지원

### CLI 인터페이스 추가
- `--migrate <path>` 옵션 추가
- `--chunk-size <size>` 마이그레이션 청크 크기 설정
- `--no-backup` 백업 생성 비활성화
- `--recursive` 재귀적 디렉토리 마이그레이션

### 안전성 기능
- 자동 백업 생성 (`.backup` 확장자)
- 임시 파일을 통한 안전한 파일 교체
- 오류 발생 시 안전한 중단 처리
- 스키마 호환성 사전 검증

### 성능 최적화
- 배치 단위 처리로 메모리 사용량 최소화
- 동적 압축 알고리즘 선택으로 최적화된 압축률과 성능
- 대용량 파일 처리 시 진행 상태 표시

## 압축 알고리즘 개선 완료 (2025년 7월 6일)

### 동적 압축 알고리즘 선택
- **파일**: `src/output/parquet.rs`, `src/migration/parquet_migrator.rs`
- **변경내용**:
  - 데이터 크기에 따른 자동 압축 알고리즘 선택 구현
  - 소형 데이터 (< 1MB): SNAPPY 압축 (빠른 속도 우선)
  - 중형 데이터 (1MB ~ 10MB): ZSTD 레벨 3 (속도와 압축률 균형)
  - 대형 데이터 (10MB ~ 100MB): ZSTD 레벨 6 (높은 압축률)
  - 초대형 데이터 (≥ 100MB): ZSTD 레벨 9 (최고 압축률)

### 압축 성능 향상
- **딕셔너리 압축 활성화**: 반복되는 문자열 데이터에 대해 압축률 향상
- **청크 단위 통계**: 성능과 압축률의 균형을 위한 통계 수집
- **압축 알고리즘별 최적화된 설정**: 각 알고리즘에 맞는 최적 파라미터 적용

### 실제 성능 테스트 결과
- **소형 파일 (0.13MB)**: SNAPPY 압축 자동 선택
  - UFS 데이터: 12.4KB (307 레코드)
  - Block 데이터: 19.7KB (433 레코드)
- **중형 파일 (13.49MB)**: ZSTD 압축 자동 선택  
  - UFS 데이터: 771.9KB (45,771 레코드)
  - Block 데이터: 976.2KB (42,373 레코드)
- **압축 선택 로직 검증**: 데이터 크기에 따른 최적 알고리즘 자동 선택 확인

### 예상 성능 개선
- **압축률**: 기존 SNAPPY 대비 20-40% 향상 (대용량 파일 기준)
- **압축 속도**: 소형 파일은 기존과 동일, 대형 파일은 약간 감소하지만 압축률 대폭 향상
- **저장 공간**: 전체적으로 20-50% 저장 공간 절약 가능
- **I/O 성능**: 압축률 향상으로 디스크 I/O 감소, 전체 성능 향상

### 호환성
- **기존 파일**: 모든 기존 Parquet 파일과 호환 가능
- **마이그레이션**: 기존 마이그레이션 도구도 동일한 압축 최적화 적용
- **자동 선택**: 사용자 개입 없이 자동으로 최적 압축 방식 선택
